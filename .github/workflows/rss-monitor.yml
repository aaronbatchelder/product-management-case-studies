name: RSS Monitor

on:
  schedule:
    # Run every 72 hours (every 3rd day) at 9am UTC
    - cron: '0 9 */3 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-feeds:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run RSS monitor
        run: npx tsx scripts/check-rss-feeds-gh.ts

      - name: Check for new candidates
        id: check-changes
        run: |
          if [ -f "new-case-studies.json" ]; then
            COUNT=$(cat new-case-studies.json | jq length)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            echo "Found $COUNT new case study candidates"
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "No new candidates found"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add ${{ steps.check-changes.outputs.count }} new case study candidates from RSS"
          title: "ðŸ“š New Case Studies: ${{ steps.check-changes.outputs.count }} candidates found"
          body: |
            The RSS monitor found **${{ steps.check-changes.outputs.count }}** new case study candidates.

            ## Review Instructions
            1. Check `new-case-studies.json` for the candidates
            2. For each one you want to keep:
               - Edit the entry in `src/data/case-studies.json`
               - Adjust title, description, category as needed
            3. Delete `new-case-studies.json` before merging
            4. Merge the PR to publish

            ---
            ðŸ¤– Generated by RSS Monitor
          branch: rss-updates/${{ github.run_number }}
          delete-branch: true
          labels: |
            case-studies
            automated
